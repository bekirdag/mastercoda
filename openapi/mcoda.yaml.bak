openapi: 3.1.0
info:
  title: Master Coda Desktop App
  version: 0.0.0
tags:
  - name: Workspaces
  - name: Tasks
  - name: Jobs
  - name: Agents
  - name: Docs
  - name: Settings
  - name: Telemetry
paths:
  /workspaces/recent:
    get:
      tags:
        - Workspaces
      summary: List recent workspaces
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: &a11
                  type: object
                  required:
                    - path
                  properties:
                    path:
                      type: string
                    lastOpened:
                      type: string
                      format: date-time
  /workspaces/select:
    post:
      tags:
        - Workspaces
      summary: Select or open a workspace
      requestBody:
        required: true
        content:
          application/json:
            schema: &a12
              type: object
              properties:
                path:
                  type: string
                initializeIfMissing:
                  type: boolean
      responses:
        "200":
          description: Workspace selected
          content:
            application/json:
              schema: &a1
                type: object
                required:
                  - path
                  - isValid
                properties:
                  path:
                    type: string
                  isValid:
                    type: boolean
                  config:
                    type: object
                    additionalProperties: true
        default:
          description: Error
          content:
            application/json:
              schema: &a6
                type: object
                required:
                  - kind
                  - code
                  - message
                properties:
                  kind:
                    type: string
                    enum:
                      - config
                      - missing_binary
                      - execution
                      - validation
                      - unknown
                  code:
                    type: string
                  message:
                    type: string
                  command:
                    type: string
                  technicalDetails:
                    type: string
  /workspaces/current:
    get:
      tags:
        - Workspaces
      summary: Get current workspace
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: *a1
  /settings:
    get:
      tags:
        - Settings
      summary: Get app settings
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: &a3
                type: object
                required:
                  - theme
                  - window
                  - recentWorkspaces
                  - preferences
                  - cli
                properties:
                  theme:
                    type: string
                  window: &a2
                    type: object
                    required:
                      - width
                      - height
                      - x
                      - y
                    properties:
                      width:
                        type: integer
                      height:
                        type: integer
                      x:
                        type: integer
                      y:
                        type: integer
                  recentWorkspaces:
                    type: array
                    items:
                      type: string
                  preferences: &a14
                    type: object
                    required:
                      - autoScrollTerminal
                      - defaultAgent
                      - showCompletedTasks
                    properties:
                      autoScrollTerminal:
                        type: boolean
                      defaultAgent:
                        type: string
                      showCompletedTasks:
                        type: boolean
                  cli: &a16
                    type: object
                    properties:
                      customPath:
                        type: string
    patch:
      tags:
        - Settings
      summary: Update app settings
      requestBody:
        required: true
        content:
          application/json:
            schema: &a13
              type: object
              properties:
                theme:
                  type: string
                window: *a2
                recentWorkspaces:
                  type: array
                  items:
                    type: string
                preferences: &a15
                  type: object
                  properties:
                    autoScrollTerminal:
                      type: boolean
                    defaultAgent:
                      type: string
                    showCompletedTasks:
                      type: boolean
                cli: &a17
                  type: object
                  properties:
                    customPath:
                      type: string
      responses:
        "200":
          description: Updated settings
          content:
            application/json:
              schema: *a3
  /backlog:
    get:
      tags:
        - Tasks
      summary: Get backlog summary
      parameters:
        - name: assignee
          in: query
          schema:
            type: string
        - name: status
          in: query
          style: form
          explode: true
          schema:
            type: array
            items: &a4
              type: string
              enum:
                - not_started
                - in_progress
                - ready_to_review
                - ready_to_qa
                - completed
                - blocked
        - name: search
          in: query
          schema:
            type: string
        - name: parentId
          in: query
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: &a21
                type: object
                required:
                  - epics
                  - stories
                  - tasks
                properties:
                  epics:
                    type: array
                    items: &a19
                      type: object
                      required:
                        - id
                        - title
                      properties:
                        id:
                          type: string
                        title:
                          type: string
                  stories:
                    type: array
                    items: &a20
                      type: object
                      required:
                        - id
                        - title
                      properties:
                        id:
                          type: string
                        title:
                          type: string
                        epic_id:
                          type: string
                  tasks:
                    type: array
                    items: &a5
                      type: object
                      required:
                        - id
                        - key
                        - title
                        - status
                        - story_points
                      properties:
                        id:
                          type: string
                        key:
                          type: string
                        title:
                          type: string
                        status: *a4
                        story_points:
                          type: integer
                        assignee:
                          type: string
                        parent_id:
                          type: string
  /tasks/{taskId}:
    get:
      tags:
        - Tasks
      summary: Get task
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: *a5
    patch:
      tags:
        - Tasks
      summary: Update task details or status
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema: &a18
              type: object
              properties:
                title:
                  type: string
                status: *a4
                story_points:
                  type: integer
                assignee:
                  type: string
                parent_id:
                  type: string
      responses:
        "200":
          description: Updated task
          content:
            application/json:
              schema: *a5
        default:
          description: Error
          content:
            application/json:
              schema: *a6
  /agents:
    get:
      tags:
        - Agents
      summary: List agents
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: &a7
                  type: object
                  required:
                    - name
                    - model
                    - status
                    - capabilities
                  properties:
                    name:
                      type: string
                    model:
                      type: string
                    status:
                      type: string
                      enum:
                        - active
                        - configured
                        - missing_auth
                    capabilities:
                      type: array
                      items:
                        type: string
  /agents/{agentName}:
    patch:
      tags:
        - Agents
      summary: Update agent configuration
      parameters:
        - name: agentName
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema: &a22
              type: object
              properties:
                baseUrl:
                  type: string
                apiKey:
                  type: string
                model:
                  type: string
      responses:
        "200":
          description: Updated agent
          content:
            application/json:
              schema: *a7
        default:
          description: Error
          content:
            application/json:
              schema: *a6
  /agents/{agentName}/test:
    post:
      tags:
        - Agents
      summary: Test agent connectivity
      parameters:
        - name: agentName
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Test result
          content:
            application/json:
              schema: &a23
                type: object
                required:
                  - status
                  - latency_ms
                properties:
                  status:
                    type: string
                    enum:
                      - healthy
                      - error
                  latency_ms:
                    type: integer
                  message:
                    type: string
  /jobs:
    post:
      tags:
        - Jobs
      summary: Start a long-running job
      requestBody:
        required: true
        content:
          application/json:
            schema: &a25
              type: object
              required:
                - type
              properties:
                type: &a8
                  type: string
                  enum:
                    - create-tasks
                    - refine-tasks
                    - work-on-tasks
                    - code-review
                    - qa-tasks
                    - docs-generate
                params:
                  type: object
                  additionalProperties: true
      responses:
        "201":
          description: Job started
          content:
            application/json:
              schema: &a9
                type: object
                required:
                  - id
                  - type
                  - status
                properties:
                  id:
                    type: string
                  dbId:
                    type: string
                  type: *a8
                  status: &a24
                    type: string
                    enum:
                      - running
                      - paused
                      - completed
                      - failed
                  progress:
                    type: number
                    minimum: 0
                    maximum: 100
                  currentStep:
                    type: string
        default:
          description: Error
          content:
            application/json:
              schema: *a6
  /jobs/{jobId}:
    get:
      tags:
        - Jobs
      summary: Get job status
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: *a9
  /jobs/{jobId}/stop:
    post:
      tags:
        - Jobs
      summary: Stop a running job
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Job stopped
  /jobs/{jobId}/input:
    post:
      tags:
        - Jobs
      summary: Send input to a running job
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema: &a26
              type: object
              required:
                - input
              properties:
                input:
                  type: string
      responses:
        "204":
          description: Input accepted
  /jobs/{jobId}/logs:
    get:
      tags:
        - Jobs
      summary: Get job logs
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: &a27
                  type: object
                  required:
                    - text
                    - stream
                  properties:
                    text:
                      type: string
                    stream:
                      type: string
                      enum:
                        - stdout
                        - stderr
                    at:
                      type: string
                      format: date-time
  /jobs/{jobId}/events:
    get:
      tags:
        - Jobs
      summary: Stream job events
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Server-sent events for job:progress, job:log, job:status, job:linked
          content:
            text/event-stream:
              schema:
                type: string
  /docs/{docType}:
    get:
      tags:
        - Docs
      summary: Get document content
      parameters:
        - name: docType
          in: path
          required: true
          schema: &a10
            type: string
            enum:
              - rfp
              - pdr
              - sds
              - architecture
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: &a28
                type: object
                required:
                  - type
                  - content
                properties:
                  type: *a10
                  content:
                    type: string
  /docs/{docType}/generate:
    post:
      tags:
        - Docs
      summary: Generate or regenerate a document
      parameters:
        - name: docType
          in: path
          required: true
          schema: *a10
      requestBody:
        required: false
        content:
          application/json:
            schema: &a29
              type: object
              properties:
                sourceType: *a10
                sourcePath:
                  type: string
      responses:
        "201":
          description: Job started
          content:
            application/json:
              schema: *a9
        default:
          description: Error
          content:
            application/json:
              schema: *a6
  /telemetry/usage:
    get:
      tags:
        - Telemetry
      summary: Get token usage and cost data
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: &a30
                type: object
                description: Output from mcoda tokens --json
                additionalProperties: true
  /telemetry/estimates:
    get:
      tags:
        - Telemetry
      summary: Get project estimate data
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: &a31
                type: object
                description: Output from mcoda estimate --json
                additionalProperties: true
components:
  schemas:
    RecentWorkspace: *a11
    WorkspaceSelectRequest: *a12
    Workspace: *a1
    Settings: *a3
    SettingsUpdate: *a13
    WindowBounds: *a2
    Preferences: *a14
    PreferencesUpdate: *a15
    CliSettings: *a16
    CliSettingsUpdate: *a17
    TaskStatus: *a4
    Task: *a5
    TaskUpdate: *a18
    Epic: *a19
    Story: *a20
    BacklogSummary: *a21
    Agent: *a7
    AgentUpdate: *a22
    AgentTestResult: *a23
    JobType: *a8
    JobStatus: *a24
    Job: *a9
    JobStartRequest: *a25
    JobInputRequest: *a26
    JobLogEntry: *a27
    DocumentType: *a10
    Document: *a28
    DocumentGenerateRequest: *a29
    TelemetryUsage: *a30
    TelemetryEstimate: *a31
    IpcError: *a6
